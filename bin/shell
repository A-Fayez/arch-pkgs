#!/bin/bash
# Starts an interactive shell with the remote repo mounted. Automatically
# unmounts the repo upon exit.
set -uo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR

source "config"

exit_cmd=""
defer() { exit_cmd="$@; $exit_cmd"; }
trap 'bash -c "$exit_cmd"' EXIT

repo="$(mktemp -d)"
defer "rmdir '$repo'"

s3fs "${BUCKET}" "$repo" -o "nosuid,nodev,default_acl=public-read"
defer "fusermount -u '$repo'"
mkdir -p "$repo/${REPO_PATH}"

export REPO=$repo

echo "You are now in a subshell with the repo mounted to \$REPO. CTRL+D or type exit to exit"
$SHELL "$@"
